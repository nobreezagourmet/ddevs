<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Cria√ß√£o de Rifa</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input, button { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; }
        input:focus { border-color: #3498db; outline: none; }
        button { background: #27ae60; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #2ecc71; }
        .status { margin-top: 20px; padding: 15px; border-radius: 6px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .image-preview { margin-top: 10px; max-width: 200px; max-height: 200px; border-radius: 6px; display: none; }
        .debug { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin-top: 20px; border-radius: 6px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≤ Painel Administrativo</h1>
            <p>Cria√ß√£o de Rifa - Vers√£o Garantida</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="form-section">
            <h2>üîê Login Administrativo</h2>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="email" placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label>Senha:</label>
                <input type="password" id="password" placeholder="Sua senha">
            </div>
            <button onclick="login()">üöÄ ENTRAR</button>
            <div id="loginStatus"></div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="form-section" style="display: none;">
            <h2>üé≤ Criar Nova Rifa</h2>
            
            <div class="form-group">
                <label>T√≠tulo da Rifa:</label>
                <input type="text" id="raffleTitle" placeholder="Ex: Rifa de Premia√ß√£o Especial">
            </div>
            
            <div class="form-group">
                <label>Imagem da Rifa:</label>
                <input type="file" id="raffleImage" accept="image/*" onchange="previewImage(event)">
                <img id="imagePreview" class="image-preview" alt="Preview">
            </div>
            
            <div class="form-group">
                <label>Pre√ßo por Cota (R$):</label>
                <input type="number" id="pricePerQuota" placeholder="10.00" step="0.01" min="0.01" value="10.00">
            </div>
            
            <div class="form-group">
                <label>Total de Cotas:</label>
                <input type="number" id="totalQuotas" placeholder="100" min="1" max="100000" value="100">
            </div>
            
            <div class="form-group">
                <label>Pacotes de Sele√ß√£o R√°pida:</label>
                <input type="text" id="quickSelectPackages" placeholder="10, 50, 100, 500" value="10, 50, 100, 500">
            </div>
            
            <button onclick="createRaffle()">üöÄ CRIAR RIFA AGORA</button>
            <div id="raffleStatus"></div>
            
            <div class="debug" id="debugInfo"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://ddevs-86w2.onrender.com';

        // LOG DE DEBUG PARA CONFIRMAR VERS√ÉO NOVA
        console.log("Conectando ao Backend em: https://ddevs-86w2.onrender.com");
        console.log("API_URL configurado:", API_URL);
        let authToken = null;
        let currentUser = null;

        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function addDebug(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        }

        function clearDebug() {
            document.getElementById('debugInfo').innerHTML = '';
        }

        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showStatus('loginStatus', '‚ùå Preencha email e senha', 'error');
                return;
            }

            showStatus('loginStatus', 'üîÑ Fazendo login...', 'info');
            addDebug(`Tentando login com: ${email}`);

            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                addDebug(`Resposta login: ${JSON.stringify(data)}`);

                if (response.ok && data.data && data.data.isAdmin) {
                    authToken = data.data.token;
                    currentUser = data.data;
                    
                    localStorage.setItem('adminToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    
                    showStatus('raffleStatus', `‚úÖ Bem-vindo, ${currentUser.email}!`, 'success');
                    addDebug('Login realizado com sucesso!');
                } else {
                    showStatus('loginStatus', '‚ùå Acesso negado. Usu√°rio n√£o √© administrador.', 'error');
                    addDebug('Acesso negado');
                }
            } catch (error) {
                showStatus('loginStatus', `‚ùå Erro: ${error.message}`, 'error');
                addDebug(`Erro no login: ${error.message}`);
            }
        }

        async function createRaffle() {
            clearDebug();
            addDebug('=== INICIANDO CRIA√á√ÉO DE RIFA ===');
            
            const title = document.getElementById('raffleTitle').value;
            const pricePerQuota = document.getElementById('pricePerQuota').value;
            const totalQuotas = document.getElementById('totalQuotas').value;
            const quickSelectPackages = document.getElementById('quickSelectPackages').value;
            const imageFile = document.getElementById('raffleImage').files[0];
            
            addDebug(`T√≠tulo: ${title}`);
            addDebug(`Pre√ßo: ${pricePerQuota}`);
            addDebug(`Cotas: ${totalQuotas}`);
            addDebug(`Pacotes: ${quickSelectPackages}`);
            addDebug(`Imagem: ${imageFile ? imageFile.name : 'Nenhuma'}`);
            addDebug(`Token: ${authToken ? 'Presente' : 'AUSENTE!'}`);
            
            if (!authToken) {
                showStatus('raffleStatus', '‚ùå Fa√ßa login primeiro!', 'error');
                return;
            }

            if (!title || !pricePerQuota || !totalQuotas) {
                showStatus('raffleStatus', '‚ùå Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            // Validar valores
            const priceNum = parseFloat(pricePerQuota);
            const quotasNum = parseInt(totalQuotas);
            
            if (isNaN(priceNum) || priceNum < 0.01) {
                showStatus('raffleStatus', '‚ùå Pre√ßo deve ser no m√≠nimo R$ 0,01', 'error');
                return;
            }
            
            if (isNaN(quotasNum) || quotasNum <= 0 || quotasNum > 100000) {
                showStatus('raffleStatus', '‚ùå Total de cotas deve ser entre 1 e 100.000', 'error');
                return;
            }

            showStatus('raffleStatus', 'üîÑ Enviando para o servidor...', 'info');
            addDebug('Criando FormData...');

            const formData = new FormData();
            formData.append('title', title);
            formData.append('pricePerQuota', pricePerQuota);
            formData.append('totalQuotas', totalQuotas);
            
            // Processar pacotes
            let packages = [];
            if (quickSelectPackages) {
                packages = quickSelectPackages.split(',').map(p => parseInt(p.trim())).filter(p => p > 0 && p <= quotasNum);
            }
            formData.append('quickSelectPackages', JSON.stringify(packages));
            
            if (imageFile) {
                formData.append('image', imageFile);
                addDebug(`Imagem adicionada: ${imageFile.name} (${imageFile.size} bytes)`);
            }

            addDebug(`FormData criado com ${formData.entries().length} campos`);

            try {
                addDebug('Enviando requisi√ß√£o para API...');
                
                const response = await fetch(`${API_URL}/api/admin/create-raffle`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                addDebug(`Status: ${response.status} ${response.statusText}`);
                addDebug(`Headers: ${JSON.stringify(Object.fromEntries(response.headers))}`);

                const data = await response.json();
                addDebug(`Resposta: ${JSON.stringify(data, null, 2)}`);

                if (response.ok && data.success) {
                    showStatus('raffleStatus', `‚úÖ ${data.message}`, 'success');
                    addDebug('RIFA CRIADA COM SUCESSO!');
                    
                    // Limpar formul√°rio
                    document.getElementById('raffleTitle').value = '';
                    document.getElementById('pricePerQuota').value = '10.00';
                    document.getElementById('totalQuotas').value = '100';
                    document.getElementById('quickSelectPackages').value = '10, 50, 100, 500';
                    document.getElementById('raffleImage').value = '';
                    document.getElementById('imagePreview').style.display = 'none';
                } else {
                    showStatus('raffleStatus', `‚ùå ${data.message || 'Erro ao criar rifa'}`, 'error');
                    addDebug(`ERRO: ${data.message}`);
                }
            } catch (error) {
                showStatus('raffleStatus', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
                addDebug(`ERRO DE CONEX√ÉO: ${error.message}`);
                addDebug(`Stack: ${error.stack}`);
            }
        }

        // Verificar login ao carregar
        window.onload = function() {
            const savedToken = localStorage.getItem('adminToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                showStatus('raffleStatus', `‚úÖ Bem-vindo de volta, ${currentUser.email}!`, 'success');
                addDebug('Usu√°rio j√° logado (localStorage)');
            }
        };
    </script>
</body>
</html>
